// compile with: /doc:xml_summary_tag.xml

using System;
using System.Collections.Generic;
using System.Text;
using MySql.Data.MySqlClient;

namespace SqlTools
{

    /*** MySqlClass
     *   
     *   dependant on SqlDataClass of same namespace
     *   constructor defaults to connStr="",current=0,connStatus=false
     *   constructor accepts string parameter and initializes connection
     *   constructor accepts parameters(strings) server,userId,pass,db and initializes connection
     *   public MySqlClass makeCopyOf(MySqlClass toCopy)
     *   protected String getConn()
     *   public bool setConn(string connection)
     *   public bool setConn(string server, string userId, string pass, string db)
     *   public bool isConnected()
     *   public bool ping()
     *   public void disconn()
     *   public bool query(string toQuery)
     *   public bool next()
     *   public SqlDataClass getVar(int col)
     *   public void getVar(int column, ref object toStore)
     *   public SqlDataClass getVar(string column)
     *   public void getVar(string column, ref object toStore)
     *   public int getColumns()
     *   public int getRows()
     *   public static int numQueries()
     *   public bool setRow(int rowNum)
     *   public dType parseType(string sType)
     *   protected string varIs(int column)
     *   public SqlDataClass nextVar()
     ***/


    /// <summary>
    /// requires that mysql-connector-net-5.0.8.1 is installed and will not function otherwise...please download that from www.localNetLive.com or redownload the latest version of SqlTools (all necessary files come with it)
    /// </summary>
    /// <type>class</type>
    public class MySqlClass
    {
        //global variables
        protected static MySqlConnection mySqlConn;
        private string connStr;
        private bool connStatus;
        protected MySqlDataReader mySqlReader;
        protected MySqlCommand mySqlQuery;
        private int current;
        private string queryString = "";
        private bool isRead;

        /// <type>List&lt;string&gt;</type>
        public readonly List<string> errors;//new
        
        /// <type>List&lt;string&gt;</type>
        public static readonly List<string> queries = new List<string>();  //new 

        #region constructors
        /// <summary>
        /// Empty constructor. Sets current conns to 0. instantiates list&lt;string&gt; errors
        /// </summary>
        public MySqlClass()
        {
            connStr = "";
            current = 0;
            connStatus = false;
            isRead = false;
            errors = new List<string>();//new
        }

        /// <summary>
        /// overloaded class initiator...for connecting at same step as initiation of class.
        /// 1 parameter(string).
        /// exa. new MySqlClass("SERVER=%server%;UID=%userId%;PASSWORD=%pass%DATABASE=%db%;");
        /// </summary>
        /// <param name="connection" type="string"></param>
        public MySqlClass(string connection)
        {
            errors = new List<string>();
            current = 0;
            connStatus = false;
            connStr = connection;
            isRead = false;

            try
            {
                mySqlConn = new MySqlConnection(connStr);
                mySqlConn.Open();
                connStatus = true;
            }
            catch (Exception e)
            {
                System.Console.WriteLine(e);
                connStatus = false;
                errors.Add(e.Message + " in constructor 2.");
                throw new Exception("MySqlClass constructor 2: \n", e);
            }

        }

        /// <summary>
        /// overloaded class initiator for initialzing connection
        /// and class in one go. parameters(strings) server,userId,pass,db
        /// </summary>
        /// <param name="server">(string)</param>
        /// <param name="userId">(string)</param>
        /// <param name="pass">(string)</param>
        /// <param name="db">(string)</param>
        public MySqlClass(string server, string userId, string pass, string db)
        {
            errors = new List<string>();
            current = 0;
            connStatus = false;
            isRead = false;
            connStr = "SERVER=" + server + ";UID=" + userId + ";PASSWORD=" + pass + "DATABASE=" + db + ";";

            try
            {
                mySqlConn = new MySqlConnection(connStr);
                mySqlConn.Open();
                connStatus = true;
            }
            catch (Exception e)
            {
                System.Console.WriteLine(e);
                connStatus = false;
                errors.Add(e.Message + " in constructor 3");
                throw new Exception("MySqlClass constructor 3: \n", e);
            }

        }
        #endregion

        /// <summary>
        /// overloaded class initiator...for copying connection
        /// to a new class so that more than one query can be
        /// made with same connection
        /// </summary>
        /// <param name="toCopy">(MySqlClass) MySqlClassToCopy</param>
        /// <returns>(MySqlClass)</returns>
        public MySqlClass makeCopyOf(MySqlClass toCopy)
        {
            return new MySqlClass(toCopy.getConn());
        }

        /// <summary>
        /// gets the connection string
        /// </summary>
        /// <returns>(string) connString</returns>
        protected String getConn()
        {
            return connStr;
        }

        #region setConn
        /// <summary>
        /// connects to db with supplied parameters(strings) server,userId,pass,dbName
        /// </summary>
        /// <param name="server">(string)</param>
        /// <param name="userId">(string)</param>
        /// <param name="pass">(string)</param>
        /// <param name="db">(string)</param>
        public void setConn(string server, string userId, string pass, string db)
        {
            connStr = "SERVER=" + server + ";UID=" + userId + ";PASSWORD=" + pass + ";DATABASE=" + db + ";";
            System.Console.WriteLine(connStr);
            try
            {
                mySqlConn = new MySqlConnection(connStr);
                mySqlConn.Open();
                connStatus = true;
            }
            catch (Exception e)
            {
                System.Console.WriteLine(e);
                connStatus = false;
                errors.Add(e.Message + " setConn(server,userId,pass,db)");
                throw new Exception("setConn(server,userId,pass,db): \n", e);
            }
        }

        /// <summary>
        /// connects to db with supplied connection string in format
        /// "SERVER=%server%;UID=%userId%;PASSWORD=%pass%;DATABASE=%dbName%;"
        /// </summary>
        /// <param name="connection">(string)</param>
        public void setConn(string connection)
        {
            connStr = connection;

            //checks to make sure string contains all 4 of variables required
            //to make a connection and follows the format:
            //"SERVER=%server%;UID=%userId%;PASSWORD=%pass%;DATABASE=%dbName%;"
            if (!connStr.Contains("SERVER="))
            {
                errors.Add("MISSING \"SERVER=%DBSERVER%\"");
                throw new Exception("MISSING \"SERVER=%DBSERVER%\"");
            }
            else if (!connStr.Contains(";UID="))
            {
                errors.Add("MISSING \";UID=%USERID%\"");
                throw new Exception("MISSING \";UID=%USERID%\"");
            }
            else if (!connStr.Contains(";PASSWORD="))
            {
                errors.Add("MISSING \";PASSWORD=%PASS%\"");
                throw new Exception("MISSING \";PASSWORD=%PASS%\"");
            }
            else if (!connStr.Contains(";DATABASE="))
            {
                errors.Add("MISSING \";DATABASE=%DBNAME%\"");
                throw new Exception("MISSING \";DATABASE=%DBNAME%\"");
            }
            else if (!connStr.EndsWith(";"))
                connStr += ";";

            try
            {
                mySqlConn = new MySqlConnection(connStr);
                mySqlConn.Open();
                connStatus = true;
            }
            catch (Exception e)
            {
                //System.Console.WriteLine(e);
                connStatus = false;
                errors.Add(e.Message + " in setConn(connection)");
                throw new Exception("setConn(connection): \n", e);
            }
        }
        #endregion

        /// <summary>
        /// returns true/false if connected
        /// </summary>
        /// <returns>(bool)</returns>
        public bool isConnected()
        {
            return connStatus;
        }

        /// <summary>
        /// sends ping request to server. returns bool
        /// </summary>
        /// <returns>(bool)</returns>
        public bool ping()
        {
            return mySqlConn.Ping();
        }

        /// <summary>
        /// disconnects if connected
        /// </summary>
        public void disconn()
        {
            if (isConnected())
                mySqlConn.Close();
        }

        /// <summary>
        /// issues a query. returns true/false for success of call
        /// </summary>
        /// <param name="toQuery">(string)</param>
        /// <returns>(bool)</returns>
        public bool query(string toQuery)
        {
            queryString = toQuery;

            if (connStatus.Equals(true))
            {
                try
                {
                    mySqlQuery = mySqlConn.CreateCommand();
                    mySqlQuery.CommandText = toQuery;
                    if (isRead.Equals(true))
                        mySqlReader.Close();
                    mySqlReader = mySqlQuery.ExecuteReader();
                    mySqlReader.Read();
                    isRead = true;
                    current = 0;
                    queries.Add(toQuery);//new
                    return true;
                }
                catch (Exception e)
                {
                    errors.Add(e.Message + " in query(toQuery)");
                    //System.Console.WriteLine("can't do somethin here man...gah...your ruining my life...");
                    throw e;
                    //return false;
                }
            }
            else
            {
                errors.Add("Not connected to DB...Cannot query until connected");
                System.Console.WriteLine("Not Connected to a Database!\n" +
                                         "Please Connect and Try Again...\n");
                return false;
            }
        }

        /// <summary>
        /// sets reader to next resultSet, returning true/false on success
        /// </summary>
        /// <returns>(bool)</returns>
        public bool next()
        {
            if (mySqlReader.Read().Equals(true))
            {
                current++;
                return true;
            }
            else
                return false;
        }

        #region Get Variables
        /// <summary>
        /// returns value @ column(x) of current row or resultSet
        /// </summary>
        /// <param name="column">(int)</param>
        /// <returns>(SqlDataClass)</returns>
        public SqlDataClass getVar(int column)
        {
            int x = column;
            SqlDataClass tmp = new SqlDataClass();

            //if(mySqlReader.GetValue.Equals(true))
            try
            {
                tmp.store(mySqlReader.GetValue(x).ToString(), parseType(mySqlReader.GetFieldType(x).ToString()));
            }
            catch (Exception e)
            {
                errors.Add(e.Message + " in getVar(int)");
                //current++;//taken out for now...why did i have it here to begin with?
                System.Console.WriteLine(current + ") SoL: " + e.Message);
            }

            if (!tmp.getString().Equals(null))
                return tmp;
            else return new SqlDataClass("no_value_to_be_read", dType.String);

            //else throw "no_value_to_be_read";
        }

        /// <summary>
        /// gets value @ column(x) of current row or resultSet and stores it to
        /// the referenced object
        /// </summary>
        /// <param name="column">(int)</param>
        /// <param name="toStore">(ref object)</param>
        public void getVar(int column, ref object toStore)
        {
            int x = column;
            SqlDataClass tmp = new SqlDataClass();

            //if(mySqlReader.GetValue.Equals(true))
            try
            {
                tmp.store(mySqlReader.GetValue(x).ToString(), parseType(mySqlReader.GetFieldType(x).ToString()));
            }
            catch (Exception e)
            {
                errors.Add(e.Message + " in getVar(int, ref object)");
                //current++;//once again, why is this here? not now...
                System.Console.WriteLine(current + ") SoL: " + e.Message);
            }

            if (!tmp.getString().Equals(null))
                tmp.putIn(ref toStore);
            else
            {
                tmp = new SqlDataClass("no_value_to_be_read", dType.String);
                tmp.putIn(ref toStore);
            }

            //else throw "no_value_to_be_read";
        }

        /// <summary>
        /// gets value at supplied column key of current row or resultSet and returns it
        ///  as a SqlDataClass
        /// </summary>
        /// <param name="column">(string)</param>
        /// <returns>(SqlDataClass)</returns>
        public SqlDataClass getVar(string column)
        {
            string x = column;
            SqlDataClass tmp = new SqlDataClass();

            //if(mySqlReader.GetValue.Equals(true))
            try
            {
                tmp.store(mySqlReader[x].ToString(), parseType(mySqlReader[x].GetType().ToString()));
            }
            catch (Exception e)
            {
                errors.Add(e.Message + " in getVar(string)");
                //current++;//wtf? what was i thinking putting this here???
                System.Console.WriteLine(current + ") SoL: " + e.Message);
            }

            if (!tmp.getString().Equals(null))
                return tmp;
            else return new SqlDataClass("no_value_to_be_read", dType.String);

            //else throw "no_value_to_be_read";
        }


        /// <summary>
        /// gets variable at supplied column key, at the current row and stores it to
        /// the referenced object
        /// </summary>
        /// <param name="column">(string)</param>
        /// <param name="toStore">(ref object)</param>
        public void getVar(string column, ref object toStore)
        {
            string x = column;
            SqlDataClass tmp = new SqlDataClass();

            //if(mySqlReader.GetValue.Equals(true))
            try
            {
                tmp.store(mySqlReader[x].ToString(), parseType(mySqlReader[x].GetType().ToString()));
            }
            catch (Exception e)
            {
                errors.Add(e.Message + " in getVar(string, ref object)");
                //current++;//omg, this is getting old, why is it here???
                System.Console.WriteLine(current + ") SoL: " + e.Message);
            }

            if (!tmp.getString().Equals(null))
                tmp.putIn(ref toStore);
            else
            {
                tmp = new SqlDataClass("no_value_to_be_read", dType.String);
                tmp.putIn(ref toStore);
            }

            //else throw "no_value_to_be_read";
        }
        #endregion

        /// <summary>
        /// gets number of columns at current rowSet
        /// </summary>
        /// <returns>(int)</returns>
        public int getColumns()
        {
            if (mySqlReader.HasRows.Equals(true))
                return mySqlReader.FieldCount;
            else
                return 0;
        }

        /// <summary>
        /// gets the number of rows in the resultSet
        /// </summary>
        /// <returns>(int)</returns>
        public int getRows()
        {
            //string rowCall = "SELECT COUNT(" + columnNames + ") FROM " + tableName;

            try
            {
                MySqlCommand rows = mySqlConn.CreateCommand();
                rows.CommandText = queryString;
                MySqlDataReader rowsFound = rows.ExecuteReader();
                int numRows = 0;

                while (rowsFound.Read().Equals(true))
                    numRows++;

                rowsFound.Close();
                return numRows;
            }
            catch (Exception e)
            {
                errors.Add("There are no rows returned for this query");
                return -1;
            }
        }

        /// <summary>
        /// gets the number of queries in list
        /// </summary>
        /// <returns>(static int)</returns>
        public static int numQueries()
        {
            return queries.Count;
        }

        /// <summary>
        /// setRow to desired row number if possible, returns false if impossible
        /// </summary>
        /// <param name="rowNumber">(int)</param>
        /// <returns>bool</returns>
        public bool setRow(int rowNumber)
        {
            if (current > rowNumber)
            {
                errors.Add("You are already on a row past the supplied row number");
                return false;
            }
            else if (getRows() < rowNumber - 1)
            {
                errors.Add("Supplied row number exceeds number of rows returned");
                return false;
            }
            else
            {
                for (int x = current; x < rowNumber; x++)
                {
                    current++;
                    next();
                }
                return true;
            }

        }

        /// <summary>
        /// returns dType.(string/bool/int/double) of value
        /// </summary>
        /// <param name="sType">(string)</param>
        /// <returns>dType</returns>
        public dType parseType(string sType)
        {
            dType tType = new dType();

            sType = sType.ToLower();
            sType = sType.Remove(0, 7);

            switch (sType)
            {
                case "string": tType = dType.String; break;
                case "boolean": //bool
                case "bool": tType = dType.Bool; break;
                case "uint32": //int
                case "uint64": //int
                case "byte": tType = dType.Integer; break;
                case "single": tType = dType.Double; break;
                default: tType = dType.String; break;
            }

            //System.Console.WriteLine(sType);

            return tType;
        }

        /// <summary>
        /// puts the type and value into a string
        /// </summary>
        /// <param name="column">(int)</param>
        /// <visibility>protected</visibility>
        /// <returns>(string)</returns>
        protected string varIs(int column)
        {
            int x = column;
            //if (mySqlReader.NextResult().Equals(true))
            System.Console.WriteLine(parseType(mySqlReader.GetValue(x).GetType().ToString()));
            return mySqlReader.GetValue(x).GetType().ToString() + "\n";// +mySqlReader.GetString(x) + "\n";
            //else
            //return "SoS";
        }

    }//end of MySqlClass

}
